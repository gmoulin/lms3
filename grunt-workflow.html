---
layout: default
title: Grunt workflow
---
<div class="intro">
	<p>

	</p>
</div>

<!-- Workflow -->
<div class="doc-section">
	<div class="page-header">
		<h1 id="workflow">Workflow:</h1>
	</div>

	<h3 id="livereload">Livereload</h3>
	<p>
		<ol>
			<li>watch css (not sass), frontend javascript, images, view templates and html files</li>
			<li>watch sass files (compiled to css with sourcemap)</li>
			<li>watch backend javascript for node server restart</li>
			<li>watch javascript test files</li>
		</ol>
	</p>

	<h3 id="end2end_tests">End to end tests</h3>
	<p>
		<ol>
			<li>specific grunt task to launch protractor, run the tests and report back</li>
		</ol>
		<p>
			Protractor launches browsers to run the integration tests, on my machine the launched browser get the focus and so I can not continue coding, so I moved it in a specific task. I will run it only when needed.<br />
		</p>
	</p>

	<h3 id="development">Development</h3>
	<p>
		<ol>
			<li>clean generated folders and files or previous builds</li>
			<li>copy components specific scripts and fonts files</li>
			<li>compile sass into css</li>
			<li>remove unused css</li>
			<li>lint css</li>
			<li>precompile partial html templates to js</li>
			<li>lint js</li>
			<li>update included stylesheets and scripts in layout</li>
			<li>run concurrent tasks for livereload, node restart, automated tests ...</li>
		</ol>
	</p>

	<h3 id="quality">Quality</h3>
	<p>
		<ol>
			<li>clean generated folders and files or previous builds</li>
			<li>clean quality folder</li>
			<li>copy components specific javascript and fonts files</li>
			<li>compile sass into css</li>
			<li>remove unused css</li>
			<li>lint css</li>
			<li>precompile partial html templates to js</li>
			<li>lint js</li>
			<li>update included stylesheets in layout</li>
			<li>replace stylesheets and scripts with concatened and minified versions</li>
			<li>copy build to quality folder</li>
			<li>run automated tests on quality folder files</li>
		</ol>
	</p>

	<h3 id="production">Production</h3>
	<p>
		<ol>
			<li>clean generated folders and files or previous builds</li>
			<li>clean production folder</li>
			<li>copy components specific javascript and fonts files</li>
			<li>compile sass into css</li>
			<li>remove unused css</li>
			<li>lint css</li>
			<li>precompile partial html templates to js</li>
			<li>lint js</li>
			<li>update included stylesheets in layout</li>
			<li>replace stylesheets and scripts with concatened and minified versions</li>
			<li>copy build to production folder</li>
			<li>run automated tests on production folder files</li>
		</ol>
	</p>
</div>
<!--/Workflow -->

<!-- Tasks -->
<div class="doc-section">
	<div class="page-header">
		<h1 id="tasks">Tasks:</h1>
	</div>

	<h3 id="linters">Linters</h3>
	<p>
		Plugins: <a href="https://github.com/gruntjs/grunt-contrib-jshint" target="_blank">grunt-contrib-jshint</a> and <a href="https://github.com/gruntjs/grunt-contrib-csslint" target="_blank">grunt-contrib-csslint</a>.<br />
		Checking syntax and errors while enforcing some rules help maintaining a sane source base across versions.<br />
		In my editor I use jslint to validate javascript syntax, using jshint in the workflow give me access to other syntax rules.<br />
		Csslint is used for css checking, as the stylesheets will be compiled from sass code, it is a quick solution to check if anything has broken.<br />
	</p>

	<h3 id="node-debug-help">Node debug help</h3>
	<p>
		Plugin: <a href="https://github.com/ChrisWren/grunt-node-inspector" target="_blank">grunt-node-inspector</a>.<br />
		Help me debug server side code in the browser.<br />
	</p>

	<h3 id="automated-tests">Automated tests</h3>
	<p>
		Framework: <a href="http://visionmedia.github.io/mocha/" target="_blank">mocha</a>.<br />
		Plugins: <br />
		<ul>
			<li><a href="https://github.com/pghalliday/grunt-mocha-test" target="_blank">grunt-mocha-test</a> for server side with coverage</li>
			<li><a href="https://github.com/ModelN/grunt-blanket-mocha" target="_blank">grunt-blanket-mocha</a> for client side with coverage and build failure if minimum coverage thresholds are not met (see <a href="http://geekdave.com/2013/08/02/automated-code-coverage-enforcement-for-mocha-using-grunt-and-blanket/" target="_blank">this post</a>) using an headless browser</li>
			<li><a href="https://github.com/stu-salsbury/grunt-blanket-mocha-server" target="_blank">grunt-blanket-mocha-server</a> for using with previous plugin, generate the <code>test-runner.html</code> file and start a connect server (in my case, I keep it running for easier test debugging)</li>
			<li><a href="https://github.com/karma-runner/grunt-karma" target="_blank">grunt-karma</a>, run tests in real browsers</li>
			<li><a href="https://github.com/karma-runner/karma-coverage" target="_blank">karma-coverage</a> to get code coverage of karma tests</li>
			<li><a href="https://github.com/karma-runner/karma-mocha" target="_blank">karma-mocha</a> to run mocha tests in karma runner</li>
			<li><a href="https://github.com/angular/protractor" target="_blank">Protractor</a> for end to end tests</a></li>
			<li><a href="https://github.com/teerapap/grunt-protractor-runner" target="_blank">grunt-protractor-runner</a></li>
		</ul>
		<br />
		Automated tests are mandatory to avoid regressions and bugs between versions. As my work session on this project can be several days apart it was paramout to have this kind of tests.<br />
		I wanted to be able to test the client and server side code with the same framework (mocha), get code coverage and have a way to run the tests in real browsers.<br />
		For end to end tests Protractor is used as it manages real browser using a Selenium web driver, but I think <a href="https://github.com/jquery/testswarm" target="_blank">testswarm</a> is more suited for the task as it supports mobiles and tablets. Problem is it does not fit well in a grunt workflow.<br />
	</p>

	<h3 id="managing-scripts-and-stylesheets">Managing scripts and stylesheets</h3>
	<p>
		Plugins: <a href="https://github.com/jwvdiermen/grunt-include-source" target="_blank">grunt-include-source</a> and <a href="https://github.com/gruntjs/grunt-contrib-copy" target="_blank">grunt-contrib-copy</a>.<br />
		Splitting code between several files is important for any javascript app, but the inclusion of all this files in the layout can quickly become a maintenance nightmare, grunt can automate this task.<br />
		I tryed and search for a grunt plugin able to add script or stylesheets into an html file at a specific place.<br />
		I also needed it to be compatible with a grunt minification plugin, including some cleverness for already minified files (third party libraries like jQuery).<br />
		The bower components minified files are copied to public folder with <a href="https://github.com/gruntjs/grunt-contrib-copy" target="_blank">grunt-contrib-copy</a>.<br />
		Order can be managed in the html code.<br />

		<br />
		For stylesheets the trick is to have one sass file including all the layers (see <a href="http://operatino.github.io/MCSS/en/" target="_blank">MCSS</a>) using sourcemap to match the sass rules while debugging and tweaking the user interface.<br />
	</p>

	<h3 id="update-html-with-minified-files">Update html with minified files</h3>
	<p>
		Plugin: <a href="https://github.com/rubenv/grunt-uglify" target="_blank">grunt-uglify</a>.<br />
		For quality and production environments I wanted to simply update the scripts and stylesheets references with concatened and minified one.<br />
		Generaly you have to already get the scripts and stylesheets references in the html for usemin to work, but since I am using <a href="https://github.com/jwvdiermen/grunt-include-source" target="_blank">grunt-include-source</a> the references will be added automaticaly.<br />
		For this trick to work grunt-include-source must run before useminPrepare, also in the html, usemin comments must surround include-source ones.<br />
		To minify the javascript, the uglify task is done separatly, to fine tune options depending on scripts (mangle part especially).
		{% highlight html %}
<!-- build:js js/app.js -->
<!-- include: "type": "js", "files": "public/scripts/**/*.js" -->
<!-- references generated by include-source -->
<script src="js/app.js"></script>
<script src="js/controllers/xyz-controller.js"></script>
<script src="js/models/xyz-model.js"></script>
<script src="js/views/xyz-view.js"></script>
<!-- endbuild -->
		{% endhighlight %}
	</p>

	<h3 id="environment-aware-layout">Environment aware layout</h3>
	<p>
		Plugin: <a href="https://github.com/jsoverson/grunt-preprocess" target="_blank">grunt-preprocess</a>.<br />
		Change page title and inject livereload script depending on environment specified variables.<br />
		{% highlight html %}
<title>
	LMS3<!-- @if SERVER!='production' --> - <!-- @echo SERVER --><!-- @endif -->
</title>

<!-- @if LIVERELOAD=true -->
<script src="//localhost:5555/livereload.js"></script>
<!-- @endif -->
		{% endhighlight %}
		{% highlight javascript %}
preprocess: {
	dev: {
		options: {
			context: { //variables for template parsing
				LIVERELOAD: true,
				SERVER: 'developement'
			}
		},
		src: '.tmp/client/index.html',
		dest: 'public/index.html',
	}
}
		{% endhighlight %}
	</p>

	<h3 id="managing-generated-files-and-folders">Managing generated files and folders</h3>
	<p>
		Plugin: <a href="https://github.com/gruntjs/grunt-contrib-clean" target="_blank">grunt-contrib-clean</a>.<br />
		Simple cleaning task to always get an up to date build.<br />
	</p>

	<h3 id="managing-file-change">Managing file change</h3>
	<p>
		Plugins: <a href="https://github.com/gruntjs/grunt-contrib-watch" target="_blank">grunt-contrib-watch</a> and <a href="https://github.com/ChrisWren/grunt-nodemon" target="_blank">grunt-nodemon</a>.<br />
		Use "livereload" feature by watching css (not sass), frontend javascript, images, view templates and html files, linked with browser plugin to fire page refresh.<br />
		Also restart node server on backend javascript files modification.<br />
		The sass files are watched for auto compilation but the "livereload" will occurs only on css files.
	</p>

	<h3 id="concurrent-tasks">Concurrent tasks</h3>
	<p>
		Plugin: <a href="https://github.com/sindresorhus/grunt-concurrent" target="_blank">grunt-concurrent</a>.<br />
		Run the "livereload" tasks concurrently (nodemon, node-inspector and watch).
	</p>

	<h3 id="precompile-templates-and-partials">Precompile templates and partials</h3>
	<p>
		Plugin: <a href="https://github.com/karlgoldstein/grunt-html2js" target="_blank">grunt-html2js</a>.<br />
		Since I want an offline first approach angular must have all the templates ready for use.
	</p>

	<h3 id="compile-sass">Compile Sass</h3>
	<p>
		Plugin: <a href="https://github.com/gruntjs/grunt-contrib-sass" target="_blank">grunt-contrib-sass</a>.<br />
		Compile the sass files into css one, also generating the sourcemap for Chrome inspector direct modification of sass file (usefull when tweaking UI).<br />
		Use a "watch" task for automated compilation on changes.
	</p>

	<h3 id="compile-sass">Dry CSS</h3>
	<p>
		Plugin: <a href="https://github.com/addyosmani/grunt-uncss" target="_blank">grunt-uncss</a>.<br />
		Remove unused stylesheets rules, for example taking a multi-page project using Bootstrap with >120KB of CSS down to 11KB.<br />
	</p>
</div>
<!--/Tasks -->
